{% extends 'home/base.html' %} {% load static %} {% block content %}

<body id="body-item-post" class="item-publish">
  {% include 'home/header.html' %}

  <div class="container">
    <div class="box">
      <h1>Post Your Company Ad</h1>
      <form name="company_item" action="{% url 'product:add_product_company' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Category Field -->
        <div class="form-section">
          <label for="id_category">{{ form.category.label }}</label>
          {{ form.category }}
        </div>
        <!-- Subcategory Field -->
        <div class="form-section" id="subcategory-section" style="display: none">
          <label for="id_subcategory">Subcategory</label>
          <select id="id_subcategory" name="subcategory" class="form-control">
            <option value="">Select subcategory</option>
            <!-- Options will be populated based on the main category selection -->
          </select>
        </div>
        <!-- Company Name Field -->
        <div class="form-section">
          {% if company_profiles %} {% if company_profiles.count > 1 %}
          <label for="id_company">{{ form.company.label }}</label>
          {{ form.company }} {% else %}
          <!-- For a single company, include a hidden field with the company's ID -->
          <input type="hidden" name="company" value="{{ company_profiles.first.id }}" />
          {% endif %} {% if form.company.errors %} {% for error in form.company.errors %}
          <div class="alert alert-danger">{{ error }}</div>
          {% endfor %} {% endif %} {% endif %}
        </div>
        {% if company_profiles %} {% with company_profile=company_profiles.first %} {% if not company_profile.address or not company_profile.city %}
        <!-- City Field -->
        {% if form.city %}
        <div class="form-section">
          <label for="id_city">{{ form.city.label }}</label>
          {{ form.city }}
        </div>
        {% endif %}
        <!-- Address Field -->
        {% if form.address %}
        <div class="form-section">
          <label for="id_address">{{ form.address.label }}</label>
          {{ form.address }}
        </div>
        {% endif %} {% endif %} {% endwith %} {% endif %}

        <!-- Phone Number Field (from CompanyProfile) -->
        <div class="form-section">
          <label for="id_phone_number">{{ form.phone_number.label }}</label>
          {{ form.phone_number }}
        </div>
        <!-- Price Field -->
        <div class="form-section">
          <label for="id_price">{{ form.price.label }}</label>
          {{ form.price }}
        </div>

        <!-- Condition Field -->
        <div class="form-section">
          <label for="id_condition">{{ form.condition.label }}</label>
          {{ form.condition }}
        </div>

        <!-- Title Field -->
        <div class="form-section">
          <label for="id_title">{{ form.title.label }}</label>
          {{ form.title }}
        </div>

        <!-- Description Field -->
        <div class="form-section">
          <label for="id_description">{{ form.description.label }}</label>
          {{ form.description }}
        </div>

        <!-- YouTube Video URL Field -->
        <div class="form-section">
          <label for="id_youtube_video_url">{{ form.youtube_video_url.label }}</label>
          {{ form.youtube_video_url }}
        </div>

        <!-- Facebook Video URL Field -->
        <div class="form-section">
          <label for="id_facebook_video_url">{{ form.facebook_video_url.label }}</label>
          {{ form.facebook_video_url }}
        </div>

        <!-- Web Link Field -->
        <div class="form-section">
          <label for="id_web_link">{{ form.web_link.label }}</label>
          {{ form.web_link }}
        </div>

        <!-- Formset for images -->
        <div class="form-section">
          <div class="image-upload-instructions">You can upload up to 15 pictures</div>
          <div class="image-upload-box">
            <label for="id_images">
              <i class="fa fa-camera" aria-hidden="true"></i>
              <!-- Use your preferred icon library -->
              <span>Click or Drop for Upload Image</span>
              <input type="file" name="images" multiple id="id_images" class="form-control" />
            </label>
          </div>
          <!-- Image preview container -->
          <div id="image-preview-container" class="image-preview-row">
            <!-- Previews will be inserted here -->
          </div>
        </div>

        <!-- Custom Fields Container -->
        <div id="custom-fields-container" class="form-section">
          <!-- Custom fields will be populated here -->
        </div>

        <!-- Messages -->
        {% if messages %}
        <div class="messages">
          {% for message in messages %}
          <div class="{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
  </div>

  {% include 'home/footer.html' %}

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      // Function to read and preview image
      function readURL(input) {
        if (input.files) {
          var container = $("#image-preview-container");
          // container.empty(); // Don't clear existing previews if you want to keep them

          $.each(input.files, function (index, file) {
            var reader = new FileReader();
            reader.onload = function (e) {
              // Create an image element for preview
              var img = $("<img>", {
                src: e.target.result,
                class: "image-preview",
                alt: "Image preview",
                style: "max-width: 100px; max-height: 100px; margin: 10px;", // Adjust the size as necessary
              });
              container.append(img); // Append new images without clearing existing ones
            };
            reader.readAsDataURL(file);
          });
        }
      }

      // Initialize previews for already selected files
      readURL($("#id_images")[0]);

      // Listen for changes in the image input
      $("#id_images").on("change", function () {
        readURL(this);
      });
    });
  </script>

  <script type="text/javascript">
    $(document).ready(function () {
      function updateSubcategoryOptions() {
        var mainCategory = $('#id_category').val();
        $('#id_subcategory').empty().append('<option value="">Select subcategory</option>');
        if (mainCategory) {
          $.getJSON('{% url 'product:ajax_load_subcategories' %}', {category_id: mainCategory},
            function (data) {
              $.each(data, function (index, item) {
                $('#id_subcategory').append($('<option>', {
                  value: item.id,
                  text: item.title
                }));
              });
              $('#subcategory-section').show(); // Show subcategory section only if main category is selected
            });

        } else {
          $('#subcategory-section').hide(); // Hide the subcategory section if no main category is selected
        }
      }

      $('#id_category').change(updateSubcategoryOptions);
      // No need to run on document ready if you want it to only show when a category is selected
    });
  </script>
  <script>
          // The rest of your code...

        $('#id_category').change(function () {
          var categoryId = $(this).val();
          loadCustomFields(categoryId);
          // No need to call updateSubcategoryOptions() here if it's already called inside loadCustomFields()
        });

        function loadCustomFields(categoryId) {
      if (!categoryId) {
        $('#custom-fields-container').empty();
        return;
      }

      $.getJSON('{% url 'product:ajax_load_custom_fields' %}', {category_id: categoryId}, function (data) {
        var container = $('#custom-fields-container');
        container.empty(); // Clear existing fields

        var fieldsHtml = '';
        $.each(data.custom_fields, function (index, field) {
          fieldsHtml += '<div class="form-group">';
          fieldsHtml += '<label for="id_custom_field_' + field.id + '">' + field.name + '</label>';

          switch(field.field_type) {
            case 'text':
            case 'number':
            case 'email':
            case 'url':
            case 'date':
              fieldsHtml += '<input type="' + field.field_type + '" class="form-control" name="custom_field_' + field.id + '" id="id_custom_field_' + field.id + '">';
              break;
            case 'textarea':
              fieldsHtml += '<textarea class="form-control" name="custom_field_' + field.id + '" id="id_custom_field_' + field.id + '"></textarea>';
              break;
            case 'select':
              fieldsHtml += '<select class="form-control" name="custom_field_' + field.id + '" id="id_custom_field_' + field.id + '">';
              field.options.split(',').forEach(function(option) {
                fieldsHtml += '<option value="' + option + '">' + option + '</option>';
              });
              fieldsHtml += '</select>';
              break;
            case 'radio':
            case 'checkbox':
              field.options.split(',').forEach(function(option) {
                fieldsHtml += '<div><input type="' + field.field_type + '" name="custom_field_' + field.id + '" id="id_custom_field_' + field.id + '_' + option + '" value="' + option + '">';
                fieldsHtml += '<label for="id_custom_field_' + field.id + '_' + option + '">' + option + '</label></div>';
              });
              break;
            // Add cases for other types if necessary
          }

          fieldsHtml += '</div>';
        });

        container.html(fieldsHtml); // Insert all fields at once
      });
    }

    $('#id_category').change(function () {
      var categoryId = $(this).val();
      loadCustomFields(categoryId);
    });
  </script>
</body>

{% endblock %}
